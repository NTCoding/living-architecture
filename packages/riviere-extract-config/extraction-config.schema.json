{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://living-architecture.dev/schemas/extraction-config.schema.json",
  "title": "Extraction Config",
  "description": "Configuration for extracting architectural components from source code",
  "type": "object",
  "required": ["modules"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference"
    },
    "modules": {
      "type": "array",
      "description": "Module definitions for component extraction",
      "minItems": 1,
      "items": {
        "oneOf": [
          { "$ref": "#/$defs/module" },
          { "$ref": "#/$defs/moduleRef" }
        ]
      }
    }
  },
  "$defs": {
    "moduleRef": {
      "type": "object",
      "description": "Reference to an external module definition file",
      "required": ["$ref"],
      "additionalProperties": false,
      "properties": {
        "$ref": {
          "type": "string",
          "description": "File path to a module definition (relative to this config file)",
          "minLength": 1
        }
      }
    },
    "module": {
      "type": "object",
      "description": "A module defines extraction rules for a path pattern",
      "required": ["name", "path"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Module name, used as the domain for extracted components",
          "minLength": 1
        },
        "path": {
          "type": "string",
          "description": "Glob pattern for files in this module",
          "minLength": 1
        },
        "extends": {
          "type": "string",
          "description": "Package name or file path to inherit component rules from",
          "minLength": 1
        },
        "api": {
          "$ref": "#/$defs/componentRule",
          "description": "Detection rule for API components"
        },
        "useCase": {
          "$ref": "#/$defs/componentRule",
          "description": "Detection rule for UseCase components"
        },
        "domainOp": {
          "$ref": "#/$defs/componentRule",
          "description": "Detection rule for DomainOp components"
        },
        "event": {
          "$ref": "#/$defs/componentRule",
          "description": "Detection rule for Event components"
        },
        "eventHandler": {
          "$ref": "#/$defs/componentRule",
          "description": "Detection rule for EventHandler components"
        },
        "ui": {
          "$ref": "#/$defs/componentRule",
          "description": "Detection rule for UI components"
        },
        "customTypes": {
          "type": "object",
          "description": "User-defined component types with their detection rules",
          "additionalProperties": {
            "$ref": "#/$defs/detectionRule"
          }
        }
      },
      "if": {
        "not": {
          "required": ["extends"]
        }
      },
      "then": {
        "required": ["api", "useCase", "domainOp", "event", "eventHandler", "ui"]
      }
    },
    "componentRule": {
      "oneOf": [
        {
          "$ref": "#/$defs/notUsed"
        },
        {
          "$ref": "#/$defs/detectionRule"
        }
      ]
    },
    "notUsed": {
      "type": "object",
      "description": "Marks this component type as not used in the module",
      "required": ["notUsed"],
      "additionalProperties": false,
      "properties": {
        "notUsed": {
          "type": "boolean",
          "const": true
        }
      }
    },
    "detectionRule": {
      "type": "object",
      "description": "Rule for detecting components of this type",
      "required": ["find", "where"],
      "additionalProperties": false,
      "properties": {
        "find": {
          "$ref": "#/$defs/findTarget"
        },
        "where": {
          "$ref": "#/$defs/predicate"
        },
        "extract": {
          "$ref": "#/$defs/extractBlock",
          "description": "Extraction rules for metadata fields"
        }
      }
    },
    "extractBlock": {
      "type": "object",
      "description": "Extraction rules mapping field names to extraction rules",
      "additionalProperties": {
        "$ref": "#/$defs/extractionRule"
      }
    },
    "extractionRule": {
      "oneOf": [
        { "$ref": "#/$defs/literalExtractionRule" },
        { "$ref": "#/$defs/fromClassNameExtractionRule" },
        { "$ref": "#/$defs/fromMethodNameExtractionRule" },
        { "$ref": "#/$defs/fromFilePathExtractionRule" },
        { "$ref": "#/$defs/fromPropertyExtractionRule" },
        { "$ref": "#/$defs/fromDecoratorArgExtractionRule" },
        { "$ref": "#/$defs/fromDecoratorNameExtractionRule" },
        { "$ref": "#/$defs/fromGenericArgExtractionRule" },
        { "$ref": "#/$defs/fromMethodSignatureExtractionRule" },
        { "$ref": "#/$defs/fromConstructorParamsExtractionRule" },
        { "$ref": "#/$defs/fromParameterTypeExtractionRule" }
      ]
    },
    "fromMethodNameExtractionRule": {
      "type": "object",
      "description": "Extracts value from the method name",
      "required": ["fromMethodName"],
      "additionalProperties": false,
      "properties": {
        "fromMethodName": {
          "oneOf": [
            { "type": "boolean", "const": true },
            {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "transform": { "$ref": "#/$defs/transform" }
              }
            }
          ]
        }
      }
    },
    "fromFilePathExtractionRule": {
      "type": "object",
      "description": "Extracts value from the file path using regex capture",
      "required": ["fromFilePath"],
      "additionalProperties": false,
      "properties": {
        "fromFilePath": {
          "type": "object",
          "required": ["pattern", "capture"],
          "additionalProperties": false,
          "properties": {
            "pattern": { "type": "string", "minLength": 1 },
            "capture": { "type": "integer", "minimum": 0 },
            "transform": { "$ref": "#/$defs/transform" }
          }
        }
      }
    },
    "fromPropertyExtractionRule": {
      "type": "object",
      "description": "Extracts value from a class property",
      "required": ["fromProperty"],
      "additionalProperties": false,
      "properties": {
        "fromProperty": {
          "type": "object",
          "required": ["name", "kind"],
          "additionalProperties": false,
          "properties": {
            "name": { "type": "string", "minLength": 1 },
            "kind": { "type": "string", "enum": ["static", "instance"] },
            "transform": { "$ref": "#/$defs/transform" }
          }
        }
      }
    },
    "fromDecoratorArgExtractionRule": {
      "type": "object",
      "description": "Extracts value from decorator argument",
      "required": ["fromDecoratorArg"],
      "additionalProperties": false,
      "properties": {
        "fromDecoratorArg": {
          "type": "object",
          "additionalProperties": false,
          "minProperties": 1,
          "properties": {
            "position": { "type": "integer", "minimum": 0 },
            "name": { "type": "string", "minLength": 1 },
            "transform": { "$ref": "#/$defs/transform" }
          }
        }
      }
    },
    "fromDecoratorNameExtractionRule": {
      "type": "object",
      "description": "Extracts value from the decorator name itself",
      "required": ["fromDecoratorName"],
      "additionalProperties": false,
      "properties": {
        "fromDecoratorName": {
          "oneOf": [
            { "type": "boolean", "const": true },
            {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "mapping": {
                  "type": "object",
                  "additionalProperties": { "type": "string" },
                  "minProperties": 1
                },
                "transform": { "$ref": "#/$defs/transform" }
              }
            }
          ]
        }
      }
    },
    "fromGenericArgExtractionRule": {
      "type": "object",
      "description": "Extracts value from generic type argument",
      "required": ["fromGenericArg"],
      "additionalProperties": false,
      "properties": {
        "fromGenericArg": {
          "type": "object",
          "required": ["interface", "position"],
          "additionalProperties": false,
          "properties": {
            "interface": { "type": "string", "minLength": 1 },
            "position": { "type": "integer", "minimum": 0 },
            "transform": { "$ref": "#/$defs/transform" }
          }
        }
      }
    },
    "fromMethodSignatureExtractionRule": {
      "type": "object",
      "description": "Extracts method parameters and return type",
      "required": ["fromMethodSignature"],
      "additionalProperties": false,
      "properties": {
        "fromMethodSignature": {
          "type": "boolean",
          "const": true
        }
      }
    },
    "fromConstructorParamsExtractionRule": {
      "type": "object",
      "description": "Extracts constructor parameter names and types",
      "required": ["fromConstructorParams"],
      "additionalProperties": false,
      "properties": {
        "fromConstructorParams": {
          "type": "boolean",
          "const": true
        }
      }
    },
    "fromParameterTypeExtractionRule": {
      "type": "object",
      "description": "Extracts type name of parameter at position",
      "required": ["fromParameterType"],
      "additionalProperties": false,
      "properties": {
        "fromParameterType": {
          "type": "object",
          "required": ["position"],
          "additionalProperties": false,
          "properties": {
            "position": { "type": "integer", "minimum": 0 },
            "transform": { "$ref": "#/$defs/transform" }
          }
        }
      }
    },
    "fromClassNameExtractionRule": {
      "type": "object",
      "description": "Extracts value from the class name",
      "required": ["fromClassName"],
      "additionalProperties": false,
      "properties": {
        "fromClassName": {
          "oneOf": [
            { "type": "boolean", "const": true },
            {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "transform": { "$ref": "#/$defs/transform" }
              }
            }
          ],
          "description": "Extract from class name, optionally with transform"
        }
      }
    },
    "transform": {
      "type": "object",
      "description": "Transform operations to apply to extracted value",
      "additionalProperties": false,
      "minProperties": 1,
      "properties": {
        "stripSuffix": { "type": "string", "minLength": 1 },
        "stripPrefix": { "type": "string", "minLength": 1 },
        "toLowerCase": { "type": "boolean", "const": true },
        "toUpperCase": { "type": "boolean", "const": true },
        "kebabToPascal": { "type": "boolean", "const": true },
        "pascalToKebab": { "type": "boolean", "const": true }
      }
    },
    "literalExtractionRule": {
      "type": "object",
      "description": "Extracts a hardcoded literal value",
      "required": ["literal"],
      "additionalProperties": false,
      "properties": {
        "literal": {
          "oneOf": [
            { "type": "string", "minLength": 1 },
            { "type": "boolean" },
            { "type": "number" }
          ],
          "description": "Literal value to use for this field"
        }
      }
    },
    "findTarget": {
      "type": "string",
      "description": "The code construct to search for",
      "enum": ["classes", "methods", "functions"]
    },
    "predicate": {
      "oneOf": [
        {
          "$ref": "#/$defs/hasDecoratorPredicate"
        },
        {
          "$ref": "#/$defs/hasJSDocPredicate"
        },
        {
          "$ref": "#/$defs/extendsClassPredicate"
        },
        {
          "$ref": "#/$defs/implementsInterfacePredicate"
        },
        {
          "$ref": "#/$defs/nameEndsWithPredicate"
        },
        {
          "$ref": "#/$defs/nameMatchesPredicate"
        },
        {
          "$ref": "#/$defs/inClassWithPredicate"
        },
        {
          "$ref": "#/$defs/andPredicate"
        },
        {
          "$ref": "#/$defs/orPredicate"
        }
      ]
    },
    "hasDecoratorPredicate": {
      "type": "object",
      "description": "Matches if the target has a specified decorator",
      "required": ["hasDecorator"],
      "additionalProperties": false,
      "properties": {
        "hasDecorator": {
          "type": "object",
          "required": ["name"],
          "additionalProperties": false,
          "properties": {
            "name": {
              "oneOf": [
                {
                  "type": "string",
                  "minLength": 1
                },
                {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "minLength": 1
                  },
                  "minItems": 1
                }
              ],
              "description": "Decorator name(s) to match"
            },
            "from": {
              "type": "string",
              "minLength": 1,
              "description": "Package the decorator is imported from"
            }
          }
        }
      }
    },
    "hasJSDocPredicate": {
      "type": "object",
      "description": "Matches if the target has a specified JSDoc tag",
      "required": ["hasJSDoc"],
      "additionalProperties": false,
      "properties": {
        "hasJSDoc": {
          "type": "object",
          "required": ["tag"],
          "additionalProperties": false,
          "properties": {
            "tag": {
              "type": "string",
              "minLength": 1,
              "description": "JSDoc tag to match (without @)"
            }
          }
        }
      }
    },
    "extendsClassPredicate": {
      "type": "object",
      "description": "Matches if the class extends a specified base class",
      "required": ["extendsClass"],
      "additionalProperties": false,
      "properties": {
        "extendsClass": {
          "type": "object",
          "required": ["name"],
          "additionalProperties": false,
          "properties": {
            "name": {
              "type": "string",
              "minLength": 1,
              "description": "Base class name to match"
            }
          }
        }
      }
    },
    "implementsInterfacePredicate": {
      "type": "object",
      "description": "Matches if the class implements a specified interface",
      "required": ["implementsInterface"],
      "additionalProperties": false,
      "properties": {
        "implementsInterface": {
          "type": "object",
          "required": ["name"],
          "additionalProperties": false,
          "properties": {
            "name": {
              "type": "string",
              "minLength": 1,
              "description": "Interface name to match"
            }
          }
        }
      }
    },
    "nameEndsWithPredicate": {
      "type": "object",
      "description": "Matches if the target name ends with a specified suffix",
      "required": ["nameEndsWith"],
      "additionalProperties": false,
      "properties": {
        "nameEndsWith": {
          "type": "object",
          "required": ["suffix"],
          "additionalProperties": false,
          "properties": {
            "suffix": {
              "type": "string",
              "minLength": 1,
              "description": "Suffix to match"
            }
          }
        }
      }
    },
    "nameMatchesPredicate": {
      "type": "object",
      "description": "Matches if the target name matches a regex pattern",
      "required": ["nameMatches"],
      "additionalProperties": false,
      "properties": {
        "nameMatches": {
          "type": "object",
          "required": ["pattern"],
          "additionalProperties": false,
          "properties": {
            "pattern": {
              "type": "string",
              "minLength": 1,
              "description": "Regex pattern to match against the name"
            }
          }
        }
      }
    },
    "inClassWithPredicate": {
      "type": "object",
      "description": "Matches if the method is in a class matching the predicate",
      "required": ["inClassWith"],
      "additionalProperties": false,
      "properties": {
        "inClassWith": {
          "$ref": "#/$defs/predicate",
          "description": "Predicate the containing class must satisfy"
        }
      }
    },
    "andPredicate": {
      "type": "object",
      "description": "Matches if all predicates match",
      "required": ["and"],
      "additionalProperties": false,
      "properties": {
        "and": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/predicate"
          },
          "minItems": 2,
          "description": "All predicates must match"
        }
      }
    },
    "orPredicate": {
      "type": "object",
      "description": "Matches if any predicate matches",
      "required": ["or"],
      "additionalProperties": false,
      "properties": {
        "or": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/predicate"
          },
          "minItems": 2,
          "description": "Any predicate must match"
        }
      }
    }
  }
}
